language: php

branches:
  except:
    - ABuseIO-3.0

os:
  - linux
  - windows

php:
  - 5.5.9
  - 5.6
  - 5.5

env:
  - DB=mysql

before_install:
  # COMMON
  - echo $TRAVIS_OS_NAME
  # LINUX
  # WINDOWS

install:
  # LINUX
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then echo 'yes' | pecl install mailparse; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then mysql -e 'CREATE DATABASE `abuseio`;'; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then composer self-update; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then composer install --dev --prefer-source --no-interaction; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then chmod -R 777 storage; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then php artisan migrate:install --no-interaction -vvv; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then chmod +x extra/notifier-samples/runall; fi
  # WINDOWS
  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then echo 'yes' | pecl install mailparse; fi

script:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then php artisan migrate --env=testing --no-interaction -vvv; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then php artisan db:seed --env=testing --no-interaction -vvv; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then vendor/bin/phpunit; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then extra/notifier-samples/runall; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then php artisan migrate:rollback --env=testing --no-interaction -vvv; fi


  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then php -v; fi
  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then cd; fi
  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then dir; fi

after_script:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then ls -laR storage/mailarchive; fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then cat storage/logs/*.log; fi

notifications:
  email:
    - dev@abuse.io
  irc:
    channels:
      - "irc.freenode.net#abuseio"
    template:
      - "%{repository}#%{build_number} (%{branch} - %{commit}) %{author}: %{message} - %{build_url}"
  on_failure: always
  on_success: change
