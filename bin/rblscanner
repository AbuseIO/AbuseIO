#!/usr/bin/php
<?php
/******************************************************************************
* AbuseIO 3.0
* Copyright (C) 2015 AbuseIO Development Team (http://abuse.io)
*
* This program is free software; you can redistribute it and/or
* modify it under the terms of the GNU General Public License
* as published by the Free Software Foundation; either version 2
* of the License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program; if not, write to the Free Software Foundation
* Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
*******************************************************************************
*
* This script will allow the scanning of a preset subset of IP addresses or IP 
* ranges based on a config file, asn or netblock argument.
*
******************************************************************************/

$asn     = '12859';

// If argument is --as $number we collect all the target ranges of that ASN using ASCC

$dns = dns_get_record("as${asn}.ascc.dnsbl.bit.nl", DNS_TXT);
foreach($dns as $key => $entry) {
    $iplist[] = $entry['entries'][0];
} 

// If the argument is --ipfile $file we read the list of targets from file

// If the argument is --zonefile $file we dont query DNS but parse the DNS zone


foreach($iplist as $netblock) {
    if(strpos("/", $netblock) !== true) {
        // Single IP's we prefix as /32
        $netblock .= "/32";
    }

    $split     = explode("/", $netblock);
    //TODO check split[0] for valid IP first
    $startstop = iprange($split[0], $split[1]);

    $netblocks[$netblock]['range']      = $split[0];
    $netblocks[$netblock]['netmask']    = $split[1];
    $netblocks[$netblock]['begin']      = $startstop['first_ip'];
    $netblocks[$netblock]['end']        = $startstop['last_ip'];
}
unset($iplist);

print_r($netblocks);

function walk_range($netblock) {

}

function parse_zonefile($file) {
    $regexp = "";
    $handle = @popen("cat ${file}", "r");
    if ($handle) {
        while (!feof($handle)) {
            $line = str_replace("\n","",fgets($handle, 4096));
            $ip = filter_var($line, FILTER_VALIDATE_IP);
            $iplong = ip2long($ip);

            foreach($netblocks as $netblock => $info) {
                if ($iplong > $info['begin'] && $iplong < $info['end']) {
                       echo "$ip is listed on $rbl" . PHP_EOL;
                }
            }

        }
    }
    pclose($handle);
}

function iprange($range_ip, $range_cidr) {   
    $corr       = (pow(2,32)-1)-(pow(2,32-$range_cidr)-1);
    $first      = ip2long($range_ip) & ($corr);
    $length     = pow(2,32-$range_cidr)-1;

    return array(
               'first_ip'=>$first,
               'last_ip'=>$first+$length
               );
}

?>
