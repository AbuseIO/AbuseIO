#!/usr/bin/php
<?php
include (realpath(dirname(__FILE__))."/../lib/core/loader.php");

$message = receive_mail(array('type' => 'EXTERNAL'));

// Sanity checks
if(empty($message['from']) || empty($message['body'])) {
    delete_store($message);
    echo "5.5.0 DENIED - Unable to process invalid message" . PHP_EOL;
    exit(EX_PERMFAIL);
}

// Maps regular expressions to match from address to the corresponding parser
$parserMap = array(
    '/autoreports@shadowserver.org/' => 'shadowserver',
    '/noreply@google.com/' => 'google',
    '/summaries@admin.spamcop.net/' => 'spamcop',
    '/@reports.spamcop.net/' => 'spamcop',
    '/autogenerated@blocklist.de/' => 'blocklist_de',
    '/@ip-echelon.com/' => 'ip_echelon',
    '/monitor-bounce@projecthoneypot.org/' => 'project_honeypot',
    '/@junkemailfilter.com/' => 'junkemailfilter_com',
    '/abuse@clean-mx.de/' => 'cleanmx_de',
    '/@USGOabuse.net/' => 'usgoabuse',
);

// Detect parser
foreach ($parserMap as $regex => $p) {
    if (preg_match($regex, $message['from'])) {
        $parser = $p;
        break;
    }
}

// If we don't have a parser, we cannot process the message
if (empty($parser)) {
    delete_store($message);
    logger(LOG_DEBUG, "Received a message from unknown sender");
    echo "4.5.0 DENIED - Unable to process message from unknown sender" . PHP_EOL;
    exit(EX_TEMPFAIL);
}

// Import the parser
logger(LOG_DEBUG, "Received a report - starting $parser parser");
require_once(APP."/lib/parsers/$parser.php");
$parser_func = "parse_$parser";
if ($parser_func($message)) {
    delete_store($message);
    echo "2.5.0 OK - The message has been delivered" . PHP_EOL;
    exit(0);
} else {
    echo "4.5.0 ERROR - Unable to process message" . PHP_EOL;
    exit(EX_TEMPFAIL);
}

?>
