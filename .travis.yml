language: php

sudo: true

branches:
  except:
    - ABuseIO-3.0

os:
  - linux

php:
  - 5.5.9
  - 5.6
  - 5.5

env:
  - DB=mysql

before_script:
  - sudo apt-get install supervisor beanstalkd
  - sudo echo "[program:abuseio_queue_emails]" >> /etc/supervisor/conf.d/abuseio_queue_email.conf
  - sudo echo "command=php artisan queue:listen --tries=1 --sleep=3 --memory=128 --delay=0 --queue=emails" >> /etc/supervisor/conf.d/abuseio_queue_email.conf
  - sudo echo "directory=/opt/abuseio" >> /etc/supervisor/conf.d/abuseio_queue_email.conf
  - sudo echo "stdout_logfile=/opt/abuseio/storage/logs/queue-emails.log" >> /etc/supervisor/conf.d/abuseio_queue_email.conf
  - sudo echo "redirect_stderr=true" >> /etc/supervisor/conf.d/abuseio_queue_email.conf
  - sudo supervisorctl reread
  - sudo supervisorctl add abuseio_queue_emails
  - sudo supervisorctl start abuseio_queue_emails
  - echo 'yes' | pecl install mailparse
  - mysql -e 'CREATE DATABASE `abuseio`;'
  - composer self-update
  - composer install --dev --prefer-source --no-interaction
  - chmod -R 777 storage
  - php artisan migrate:install --no-interaction -vvv
  - chmod +x extra/notifier-samples/runall

script:
  - php artisan migrate --env=testing --no-interaction -vvv
  - php artisan db:seed --env=testing --no-interaction -vvv
  - vendor/bin/phpunit
  - extra/notifier-samples/runall
  - php artisan migrate:rollback --env=testing --no-interaction -vvv

after_script:
  - ls -laR storage/mailarchive
  - cat storage/logs/*.log

notifications:
  email:
    - dev@abuse.io
  irc:
    channels:
      - "irc.freenode.net#abuseio"
    template:
      - "%{repository}#%{build_number} (%{branch} - %{commit}) %{author}: %{message} - %{build_url}"
  on_failure: always
